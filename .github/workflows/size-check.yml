name: Bundle Size Check

on:
  pull_request:
    branches: [main]

jobs:
  size:
    name: Check Bundle Size
    runs-on: ubuntu-latest

    steps:
      - name: Checkout PR
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Enable Corepack
        run: corepack enable

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      - name: Build
        run: yarn build

      - name: Get PR bundle sizes
        id: pr_size
        run: |
          ESM_SIZE=$(gzip -c dist/index.js | wc -c)
          CJS_SIZE=$(gzip -c dist/index.cjs | wc -c)
          echo "esm=$ESM_SIZE" >> $GITHUB_OUTPUT
          echo "cjs=$CJS_SIZE" >> $GITHUB_OUTPUT

      - name: Checkout base branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.base_ref }}
          path: base

      - name: Build base branch
        working-directory: base
        run: |
          corepack enable
          yarn install --frozen-lockfile
          yarn build

      - name: Get base bundle sizes
        id: base_size
        working-directory: base
        run: |
          ESM_SIZE=$(gzip -c dist/index.js | wc -c)
          CJS_SIZE=$(gzip -c dist/index.cjs | wc -c)
          echo "esm=$ESM_SIZE" >> $GITHUB_OUTPUT
          echo "cjs=$CJS_SIZE" >> $GITHUB_OUTPUT

      - name: Calculate size differences
        id: diff
        run: |
          ESM_DIFF=$((${{ steps.pr_size.outputs.esm }} - ${{ steps.base_size.outputs.esm }}))
          CJS_DIFF=$((${{ steps.pr_size.outputs.cjs }} - ${{ steps.base_size.outputs.cjs }}))

          echo "esm=$ESM_DIFF" >> $GITHUB_OUTPUT
          echo "cjs=$CJS_DIFF" >> $GITHUB_OUTPUT

      - name: Comment on PR
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const esmDiff = ${{ steps.diff.outputs.esm }};
            const cjsDiff = ${{ steps.diff.outputs.cjs }};

            const formatSize = (bytes) => `${bytes} B`;
            const formatDiff = (diff) => {
              if (diff === 0) return '¬±0 B';
              const sign = diff > 0 ? '+' : '';
              return `${sign}${diff} B`;
            };

            const emoji = (diff) => {
              if (diff === 0) return '‚ö™';
              if (diff > 100) return 'üî¥';
              if (diff > 0) return 'üü°';
              return 'üü¢';
            };

            const body = `## Bundle Size Report

            | File | Base | PR | Change |
            |------|------|-----|---------|
            | index.js ESM (gzip) | ${formatSize(${{ steps.base_size.outputs.esm }})} | ${formatSize(${{ steps.pr_size.outputs.esm }})} | ${emoji(esmDiff)} ${formatDiff(esmDiff)} |
            | index.cjs CJS (gzip) | ${formatSize(${{ steps.base_size.outputs.cjs }})} | ${formatSize(${{ steps.pr_size.outputs.cjs }})} | ${emoji(cjsDiff)} ${formatDiff(cjsDiff)} |

            ${esmDiff > 200 ? '‚ö†Ô∏è **Warning**: ESM bundle size increased by more than 200 bytes' : ''}
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

      - name: Fail if size increased too much
        run: |
          ESM_DIFF=${{ steps.diff.outputs.esm }}
          if [ $ESM_DIFF -gt 500 ]; then
            echo "‚ùå ESM bundle size increased by more than 500 bytes!"
            exit 1
          fi
          echo "‚úÖ Bundle size increase acceptable"
